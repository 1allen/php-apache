version: v1.0
name: php-apache semaphore ci
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: build
    skip:
      when: "branch = 'master'"
    task:
      prologue:
        commands:
          - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
      jobs:
        - name: docker build & push
          commands:
            - checkout
            - docker pull "$IMAGE_NAME:IMAGE_TAG" || true
            - docker build --cache-from "$IMAGE_NAME:$IMAGE_TAG" . -f Dockerfile.ubuntu -t "$IMAGE_NAME_BASE:$IMAGE_TAG"
            - docker tag "$IMAGE_NAME_BASE:$IMAGE_TAG" "$IMAGE_NAME:$IMAGE_TAG"
            - docker push "$IMAGE_NAME:IMAGE_TAG"
      secrets:
        - name: dockerhub-1allen
      env_vars:
        - name: IMAGE_NAME
          value: 1allen/php-apache
        - name: IMAGE_TAG
          value: ${SEMAPHORE_GIT_BRANCH:-SEMAPHORE_GIT_TAG_NAME}
        - name: IMAGE_NAME_BASE
          value: php-apache
